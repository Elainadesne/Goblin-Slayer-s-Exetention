# 重新加载功能说明

## 🔄 功能概述

扩展现在提供了两种重新加载方式：

1. **扩展级重新加载**：只重新初始化扩展，不刷新浏览器
2. **浏览器级刷新**：完全刷新页面（用户手动操作）

## 📋 使用场景

### 1. MVU 初始化超时

**问题**：酒馆启动慢，MVU 扩展加载时间超过扩展的等待时间

**解决方案**：
- 错误面板会自动显示，包含详细日志
- 点击"重新加载"按钮
- 扩展会重新等待 MVU 模块，而不是刷新整个浏览器

### 2. 数据显示异常

**问题**：数据没有正确显示或更新

**解决方案**：
- 右键点击悬浮按钮
- 选择"重新加载数据"
- 扩展会重新获取所有数据并刷新显示

### 3. 扩展卡住或无响应

**问题**：扩展界面卡住，无法正常操作

**解决方案**：
- 右键点击悬浮按钮
- 选择"重新加载数据"
- 如果仍然无效，刷新浏览器页面

## 🛠️ 重新加载流程

### 错误面板的重新加载

当扩展初始化失败时：

```
1. 显示错误面板
   ├── 错误标题和消息
   ├── 详细日志（可展开）
   └── 操作按钮
       ├── 🔄 重新加载（重新初始化扩展）
       ├── 📋 复制日志（复制所有日志）
       └── ✕ 关闭（关闭错误面板）

2. 点击"重新加载"
   ├── 关闭错误面板
   ├── 清理现有应用实例
   ├── 移除现有面板 DOM
   ├── 重新检查 API 就绪状态
   ├── 重新等待 Mvu 模块
   └── 重新初始化应用

3. 如果成功
   └── 正常显示面板

4. 如果再次失败
   └── 再次显示错误面板
```

### 右键菜单的重新加载

通过右键菜单触发：

```
1. 右键点击悬浮按钮
   └── 选择"重新加载数据"

2. 重新加载流程
   ├── 显示加载提示
   ├── 调用 app.reinitialize()
   │   ├── 清除所有缓存
   │   ├── 重新等待 Mvu 模块
   │   ├── 重新加载所有数据
   │   └── 重新渲染界面
   └── 显示成功/失败提示

3. 如果成功
   └── 显示"数据已重新加载"

4. 如果失败
   ├── 显示错误消息
   └── 提供进一步的建议
```

## 📊 详细日志

### 早期日志（script.js）

在主应用加载之前记录：

- ✅ 扩展开始加载
- ✅ 当前时间
- ✅ API 就绪检查
- ✅ 缺失的 API 列表
- ✅ 检查次数和超时
- ✅ 模块加载状态

### 应用日志（app.js）

应用初始化过程：

- ✅ 初始化开始
- ✅ 版本信息
- ✅ 面板 HTML 加载
- ✅ Mvu 模块等待
- ✅ Mvu 方法检查
- ✅ 数据加载过程
- ✅ 渲染完成

### 数据管理日志（data_manager.js）

数据加载详情：

- ✅ MVU 数据加载开始
- ✅ MVU API 检查
- ✅ 原始数据获取
- ✅ 数据格式识别
- ✅ 数据键统计
- ✅ 加载成功/失败

## 🔍 错误诊断

### 查看详细日志

1. **错误面板中**
   - 点击"查看详细日志"展开
   - 查看所有早期日志
   - 点击"复制日志"复制到剪贴板

2. **日志标签页中**
   - 打开面板（如果可以）
   - 切换到"日志"标签
   - 使用筛选功能查看错误
   - 点击"复制全部"复制日志

3. **浏览器控制台中**
   - 按 F12 打开开发者工具
   - 切换到 Console 标签
   - 查找 `[GS StatusBar]` 前缀的日志

### 常见错误和解决方案

#### 1. "Mvu module failed to load within the timeout period"

**原因**：MVU 扩展未加载或加载太慢

**解决方案**：
1. 检查 MVU 扩展是否已安装并启用
2. 点击错误面板的"重新加载"按钮
3. 如果仍然失败，刷新浏览器页面
4. 检查浏览器控制台是否有 MVU 相关错误

#### 2. "API 初始化超时"

**原因**：SillyTavern 核心 API 未就绪

**解决方案**：
1. 等待酒馆完全加载
2. 点击"重新加载"按钮
3. 检查日志中缺失的 API 列表
4. 确保酒馆版本兼容

#### 3. "MVU API 未找到或未就绪"

**原因**：MVU 扩展未正确初始化

**解决方案**：
1. 检查 MVU 扩展是否在扩展列表中
2. 尝试禁用后重新启用 MVU 扩展
3. 点击"重新加载"按钮
4. 如果问题持续，重新安装 MVU 扩展

## 💡 最佳实践

### 何时使用重新加载

✅ **应该使用重新加载**：
- MVU 初始化超时
- 数据显示不正确
- 切换角色后数据未更新
- 扩展界面卡住

❌ **不应该使用重新加载**：
- 正常的数据更新（会自动更新）
- 主题切换（不需要重新加载）
- 面板打开/关闭（正常操作）

### 性能考虑

- **重新加载耗时**：通常 2-5 秒
- **数据缓存**：重新加载会清除所有缓存
- **频率限制**：避免频繁重新加载

### 调试技巧

1. **启用控制台输出**
   - 右键悬浮按钮 → "切换控制台输出"
   - 在浏览器控制台查看详细日志

2. **导出日志**
   - 打开日志标签页
   - 点击"复制全部"
   - 粘贴到文本文件保存

3. **查看早期日志**
   - 在控制台输入：`window.gsStatusBarEarlyLogs`
   - 查看扩展加载的最早期日志

## 🐛 故障排除

### 重新加载按钮无响应

1. 检查浏览器控制台是否有 JavaScript 错误
2. 尝试刷新浏览器页面
3. 检查扩展文件是否完整

### 重新加载后仍然失败

1. 查看详细日志，找出根本原因
2. 检查 MVU 扩展状态
3. 尝试刷新浏览器页面
4. 重新安装扩展

### 日志无法复制

1. 手动选择日志文本
2. 使用 Ctrl+C (Windows) 或 Cmd+C (Mac) 复制
3. 检查浏览器的剪贴板权限

## 📝 技术细节

### 重新加载 vs 刷新页面

| 操作 | 重新加载扩展 | 刷新页面 |
|------|------------|---------|
| 速度 | 快（2-5秒） | 慢（取决于网络） |
| 影响范围 | 只影响扩展 | 影响整个页面 |
| 数据保留 | 酒馆数据保留 | 所有数据重新加载 |
| 聊天记录 | 保留 | 保留 |
| 其他扩展 | 不影响 | 全部重新加载 |

### 实现原理

```javascript
// 错误面板的重新加载
1. 清理现有实例
   - delete window.gsStatusBarApp
   - 移除面板 DOM

2. 重新初始化
   - 重新检查 API
   - 重新导入 app.js
   - 重新创建应用实例

// 右键菜单的重新加载
1. 调用 app.reinitialize()
   - 清除缓存
   - 重新等待 Mvu
   - 重新加载数据
   - 重新渲染界面
```

## 🎯 未来改进

- [ ] 添加重新加载进度指示器
- [ ] 支持部分重新加载（只重新加载特定模块）
- [ ] 自动重试机制（失败后自动重试）
- [ ] 重新加载历史记录
- [ ] 性能监控和优化建议
